<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Character Sorter ‚Äî Stable</title>
<style>
  :root{
    --bg:#f6efe9; --layer:#ffffff; --layer2:#fbf7f3;
    --text:#26272b; --muted:#6e6b66; --border:#e7ddd2;
    --accent:#5865f2; --btn:#efe6dc; --btnH:#e7dccf;
    --danger:#c44949; --ok:#3c7f5e;
    --shadow:0 1px 0 rgba(0,0,0,.03), 0 10px 20px rgba(0,0,0,.04);
    --radius:14px;
  }
  [data-theme="dark"]{
    --bg:#2b2d31; --layer:#313338; --layer2:#2f3136;
    --text:#f2f3f5; --muted:#aeb3bd; --border:#3f4147;
    --accent:#5865f2; --btn:#3b3d45; --btnH:#4a4d56;
    --danger:#d06b6b; --ok:#5bb38c;
    --shadow:0 0 0 rgba(0,0,0,0), 0 12px 24px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:2;background:var(--layer);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
  h1{margin:0;font-size:18px;letter-spacing:.2px}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}

  .btn{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:var(--btn);cursor:pointer;color:var(--text)}
  .btn:hover{background:var(--btnH)}
  .btn-danger{border-color:color-mix(in oklab, var(--danger), transparent 40%)}
  .btn-ok{border-color:color-mix(in oklab, var(--ok), transparent 40%)}
  .btn-accent{background:var(--layer);border-color:color-mix(in oklab,var(--accent),transparent 55%);box-shadow:var(--shadow)}
  .btn-accent:hover{background:var(--layer2)}

  .card{background:var(--layer);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);margin-bottom:14px}
  .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:15px;background:var(--layer2)}
  .card .body{padding:12px 14px}
  input,textarea{width:100%;background:var(--layer);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px;font:inherit}
  input:focus,textarea:focus,.btn:focus{outline:2px solid rgba(88,101,242,.35);outline-offset:2px}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .rowCard{display:grid;grid-template-columns:56px 1.1fr 1.5fr auto;gap:10px;align-items:center;background:var(--layer);border:1px solid var(--border);border-radius:12px;padding:8px}
  .rowCard img{width:56px;height:56px;object-fit:cover;border-radius:12px;background:var(--layer2);border:1px solid var(--border)}
  .hint{color:var(--muted);font-size:12px}

  .footerStart{margin-top:18px;display:flex;justify-content:center}
  .footerStart .btn{font-size:18px;padding:14px 22px}

  .pair{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .char{background:var(--layer);border:1px solid var(--border);border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .06s ease, box-shadow .06s ease,border-color .06s}
  .char:hover{transform:translateY(-1px);border-color:color-mix(in oklab,var(--accent),transparent 60%)}
  .char img{width:100%;aspect-ratio:1/1;object-fit:cover;background:var(--layer2)}
  .meta{padding:10px;text-align:center;font-weight:700}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}

  ol{margin:0;padding:0;list-style:none;display:grid;gap:8px}
  .resRow{display:flex;align-items:center;gap:10px;background:var(--layer);border:1px solid var(--border);border-radius:12px;padding:6px}
  .resRow img{width:42px;height:42px;object-fit:cover;border-radius:10px;background:var(--layer2);border:1px solid var(--border)}
  .rank{width:34px;height:34px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:var(--layer2);border:1px solid var(--border);font-weight:700;color:var(--muted)}
  .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0;color:var(--muted);font-size:13px}
  .error{background:#ffd8d6;border:1px solid #e3a4a0;color:#6b2c2c;padding:8px;border-radius:10px;margin:.5rem 0;display:none}
  @media(max-width:800px){.grid2{grid-template-columns:1fr}.pair{grid-template-columns:1fr 1fr}.rowCard{grid-template-columns:56px 1fr 1fr auto}}
</style>
</head>
<body>
<header>
  <h1>Character Sorter</h1>
  <button id="themeBtn" class="btn">üåô Dark</button>
</header>

<div class="wrap">
  <!-- CREATE -->
  <section id="page-create">
    <div id="errC" class="error"></div>

    <div class="card">
      <h2>Create list</h2>
      <div class="body">
        <p class="hint">Add characters (name + image URL). If image is empty, preview shows a colored ‚Äú?‚Äù but the field stays empty.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px">
          <button id="addRow" class="btn">+ Add character</button>
          <button id="clearList" class="btn btn-danger">Clear</button>
          <button id="resetDefault" class="btn btn-danger">Reset to default</button>
        </div>
        <div id="rows" style="display:grid;gap:8px"></div>
      </div>
    </div>

    <div class="card">
      <h2>Save / Load (CS1)</h2>
      <div class="body grid2">
        <div>
          <textarea id="exportCode" rows="6" readonly placeholder="Click ‚ÄúGenerate code‚Äù"></textarea>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button id="genCode" class="btn btn-ok">Generate code</button>
            <button id="copyCode" class="btn">Copy code</button>
            <button id="copyLink" class="btn">Copy shareable link</button>
          </div>
        </div>
        <div>
          <textarea id="importCode" rows="6" placeholder="Paste CS1 code here"></textarea>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button id="loadCode" class="btn">Load code</button>
          </div>
        </div>
      </div>
    </div>

    <div class="footerStart">
      <button id="startSorting" class="btn btn-accent" style="font-weight:800">Start sorting</button>
    </div>
  </section>

  <!-- SORT -->
  <section id="page-sort" style="display:none">
    <div id="errS" class="error"></div>
    <div class="card">
      <h2>Duels</h2>
      <div class="body">
        <div class="bar"><span id="status">Ready.</span><span id="progress"></span></div>
        <div id="pair" class="pair" style="display:none">
          <div id="charA" class="char"><img id="imgA" alt=""><div class="meta" id="nameA">‚Äî</div></div>
          <div id="charB" class="char"><img id="imgB" alt=""><div class="meta" id="nameB">‚Äî</div></div>
        </div>
        <div class="controls">
          <button id="tie" class="btn">Tie</button>
          <button id="undo" class="btn">‚Ü©Ô∏é Undo</button>
          <button id="resetSort" class="btn">Reset</button>
          <button id="shareLinkSort" class="btn">Copy shareable link</button>
          <button id="backToCreate" class="btn">‚Üê Back</button>
        </div>
        <p class="hint" style="text-align:center">Shortcuts: A / T / B</p>
      </div>
    </div>

    <div class="card">
      <h2>Results</h2>
      <div class="body"><ol id="result"></ol></div>
    </div>
  </section>
</div>

<script>
// ===== Theme =====
const THEME_KEY='cs_theme';
function applyTheme(t){document.documentElement.setAttribute('data-theme',t==='dark'?'dark':'light');}
function currentTheme(){return localStorage.getItem(THEME_KEY)||'light';}
function toggleTheme(){const t=currentTheme()==='dark'?'light':'dark';localStorage.setItem(THEME_KEY,t);applyTheme(t);document.getElementById('themeBtn').textContent=t==='dark'?'‚òÄÔ∏è Light':'üåô Dark';}
applyTheme(currentTheme()); document.getElementById('themeBtn').textContent=currentTheme()==='dark'?'‚òÄÔ∏è Light':'üåô Dark';
document.getElementById('themeBtn').onclick=toggleTheme;

// ===== Utils & Storage =====
const $=s=>document.querySelector(s);
const LS_KEY='cs_pool_v1';
function savePool(list){localStorage.setItem(LS_KEY,JSON.stringify(list));}
function loadPool(){try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]');}catch{return[]}}
function showErr(scope,msg){const el=(scope==='C'?$('#errC'):$('#errS')); el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none';},3500);}

// ===== Placeholder ‚Äú?‚Äù =====
const palette=['#ffb6a3','#ffd2a6','#ffe6a8','#c8f0a8','#b7e5ff','#cbb8ff','#ffb8e1','#b8ffe7'];
function hashInt(s){let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}return h>>>0;}
function questionSVG(n){const bg=palette[hashInt(n)%palette.length];return'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="26" fill="${bg}"/><text x="50%" y="58%" font-size="280" text-anchor="middle" fill="#222" font-family="system-ui" dy=".1em">?</text></svg>`);}
function placeholderFor(n){return questionSVG(n||'Character');}

// ===== Model (editList) =====
let editList = []; // [{name:'', image:''}]
function defaultPool(){
  return [
    {name:'Scooby-Doo',    image:''},
    {name:'Shaggy Rogers', image:''},
    {name:'Velma Dinkley', image:''},
    {name:'Daphne Blake',  image:''},
    {name:'Fred Jones',    image:''}
  ];
}
function renderRows(){
  const rowsEl=document.getElementById('rows');
  rowsEl.innerHTML='';
  editList.forEach((item,idx)=>{
    const div=document.createElement('div'); div.className='rowCard'; div.dataset.idx=idx;
    const preview = (item.image && item.image.trim()) ? item.image : placeholderFor(item.name||'Character');
    div.innerHTML = `
      <img class="pimg" src="${preview}" alt="">
      <input class="nm" type="text" placeholder="Name" value="${item.name||''}">
      <input class="im" type="url" placeholder="Image URL (optional)" value="${item.image||''}">
      <button class="btn btn-danger del">Delete</button>
    `;
    rowsEl.appendChild(div);
  });
}
function loadInitial(){
  const stored=loadPool();
  editList = Array.isArray(stored)&&stored.length ? stored.map(x=>({name:x.name||'', image:(x.image??'')})) : defaultPool();
  renderRows(); savePool(editList);
}
loadInitial();

// ===== Row events (no full re-render on typing) =====
document.getElementById('rows').addEventListener('input', (e)=>{
  const row = e.target.closest('.rowCard'); if(!row) return;
  const idx = +row.dataset.idx;
  if(e.target.classList.contains('nm')){
    editList[idx].name = e.target.value;
    // update preview only if image is empty
    if(!(editList[idx].image && editList[idx].image.trim())){
      row.querySelector('.pimg').src = placeholderFor(editList[idx].name||'Character');
    }
  }else if(e.target.classList.contains('im')){
    editList[idx].image = e.target.value; // can be empty string
    const src = (editList[idx].image && editList[idx].image.trim()) ? editList[idx].image : placeholderFor(editList[idx].name||'Character');
    row.querySelector('.pimg').src = src;
  }
  savePool(editList); // no re-render ‚Üí focus preserved
});

document.getElementById('rows').addEventListener('click', (e)=>{
  if(!e.target.classList.contains('del')) return;
  const row = e.target.closest('.rowCard'); const idx=+row.dataset.idx;
  editList.splice(idx,1);
  renderRows(); savePool(editList);
});

document.getElementById('addRow').onclick=()=>{ editList.push({name:'', image:''}); renderRows(); savePool(editList); };
document.getElementById('clearList').onclick=()=>{ if(confirm('Clear the list?')){ editList = []; renderRows(); savePool(editList); } };
document.getElementById('resetDefault').onclick=()=>{ if(!confirm('Reset to default (Scooby)?')) return; editList = defaultPool(); renderRows(); savePool(editList); showErr('C','Reset done.'); };

// ===== Codes (CS1 simples, robustes) =====
function encodeCode(list){
  const json = JSON.stringify(list);
  const b64 = btoa(unescape(encodeURIComponent(json))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  return 'CS1.'+b64;
}
function decodeCode(code){
  const t=(code||'').trim(); if(!/^CS1\.[A-Za-z0-9\-_]+$/.test(t)) throw new Error('Invalid code format.');
  const p=t.slice(4).replace(/-/g,'+').replace(/_/g,'/'); const pad=p.length%4?'===='.slice(p.length%4):'';
  const json=decodeURIComponent(escape(atob(p+pad))); const arr=JSON.parse(json);
  if(!Array.isArray(arr)) throw new Error('Code does not contain a list.');
  return arr.map(x=>({name:x.name||'', image:(x.image??'')})); // keep empty string
}
function encodeShareLink(list){
  const b64=btoa(unescape(encodeURIComponent(JSON.stringify(list)))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  return location.origin+location.pathname+'#data='+b64;
}
document.getElementById('genCode').onclick=()=>{ try{
  const usable = editList.filter(x=>x.name && x.name.trim()).map(x=>({name:x.name.trim(), image:(x.image||'')})); // keep empty
  if(usable.length<2) throw new Error('Add at least 2 characters.');
  document.getElementById('exportCode').value = encodeCode(usable);
}catch(e){ showErr('C', e.message||e); } };
document.getElementById('copyCode').onclick=async()=>{ try{
  const v=document.getElementById('exportCode').value.trim(); if(!v) throw new Error('Generate a code first.');
  await navigator.clipboard.writeText(v); alert('Code copied!');
}catch(e){ showErr('C', e.message||e); } };
document.getElementById('copyLink').onclick=async()=>{ try{
  const usable = editList.filter(x=>x.name && x.name.trim()).map(x=>({name:x.name.trim(), image:(x.image||'')})); if(usable.length<2) throw new Error('Add at least 2 characters.');
  const url=encodeShareLink(usable); await navigator.clipboard.writeText(url); alert('Shareable link copied!');
}catch(e){ showErr('C', e.message||e); } };
document.getElementById('loadCode').onclick=()=>{ try{
  const code=document.getElementById('importCode').value.trim(); if(!code) throw new Error('Paste a code first.');
  editList = decodeCode(code); renderRows(); savePool(editList); alert('List imported!');
}catch(e){ showErr('C', e.message||e); } };

// ===== Navigation
function switchTab(which){
  document.getElementById('page-create').style.display = which==='create'?'block':'none';
  document.getElementById('page-sort').style.display   = which==='create'?'none':'block';
}
document.getElementById('startSorting').onclick=()=>{ try{
  const usable = editList.filter(x=>x.name && x.name.trim()).map(x=>({name:x.name.trim(), image:x.image||''}));
  if(usable.length<2) throw new Error('Add at least 2 characters.');
  poolForSorter = usable.map(x=>({name:x.name, image: (x.image && x.image.trim()) ? x.image : placeholderFor(x.name)}));
  switchTab('sort'); startInteractiveSort(poolForSorter);
}catch(e){ showErr('C', e.message||e); } };
document.getElementById('backToCreate').onclick=()=> switchTab('create');

// ===== Sort engine (interactive merge sort + undo) =====
let poolForSorter=[], pending=[], nextRuns=[], current=null, result=null;
let comparisonsDone=0, comparisonsTotal=0;
let historySnaps=[]; let latestResult=[];

function snapshot(){return JSON.stringify({pending,nextRuns,comparisonsDone});}
function restoreSnapshot(s){const o=JSON.parse(s); pending=o.pending; nextRuns=o.nextRuns; comparisonsDone=o.comparisonsDone; result=null; current=null;}
function estimate(n){return Math.max(0,Math.floor(n*Math.log2(Math.max(1,n))));}
function makeMerges(runs){const merges=[]; for(let i=0;i<runs.length;i+=2){const L=runs[i].slice(); const R=i+1<runs.length?runs[i+1].slice():[]; merges.push({left:L,right:R,out:[]});} return merges;}
function setStatus(t){document.getElementById('status').textContent=t;}
function setProgress(d,t){document.getElementById('progress').textContent=t?`Comparisons: ${d}/${t}`:"";}
function showPair(a,b){
  document.getElementById('pair').style.display='grid';
  document.getElementById('nameA').textContent=a.name; document.getElementById('imgA').src=a.image;
  document.getElementById('nameB').textContent=b.name; document.getElementById('imgB').src=b.image;
}
function startInteractiveSort(items){
  pending=makeMerges(items.map(x=>[x])); nextRuns=[]; current=null; result=null; historySnaps=[]; latestResult=[];
  comparisonsDone=0; comparisonsTotal=estimate(items.length); setProgress(comparisonsDone,comparisonsTotal);
  document.getElementById('result').innerHTML="";
  if(pending.length===1 && pending[0].right.length===0){ result=pending[0].left; document.getElementById('pair').style.display='none'; return renderResult(result); }
  step();
}
function step(){
  if(current) return;
  if(pending.length===0){
    if(nextRuns.length===1){ result=nextRuns[0]; document.getElementById('pair').style.display='none'; return renderResult(result); }
    pending=makeMerges(nextRuns); nextRuns=[];
  }
  const m=pending[0]; if(!m) return;
  if(m.left.length===0 && m.right.length===0){ nextRuns.push(m.out); pending.shift(); return step(); }
  if(m.left.length===0){ m.out.push(m.right.shift()); return step(); }
  if(m.right.length===0){ m.out.push(m.left.shift()); return step(); }
  const A=m.left[0], B=m.right[0];
  showPair(A,B); setStatus("Choose: click A / Tie / click B");
  current={resolve:(choice)=>{
    historySnaps.push(snapshot());
    if(choice==="A") m.out.push(m.left.shift());
    else if(choice==="B") m.out.push(m.right.shift());
    else { const x=m.left.shift(), y=m.right.shift(); m.out.push(x,y); }
    comparisonsDone++; setProgress(comparisonsDone,comparisonsTotal);
    current=null; setTimeout(step,0);
  }};
}
function renderResult(arr){
  setStatus("Sorting finished üéâ"); latestResult = arr.slice();
  const ol=document.getElementById('result'); ol.innerHTML="";
  arr.forEach((x,i)=>{
    const li=document.createElement('li'); li.className='resRow';
    li.innerHTML=`<div class="rank">${i+1}</div><img src="${x.image}" alt=""><div class="nm">${x.name}</div>`;
    ol.appendChild(li);
  });
}
document.getElementById('charA').onclick=()=> current && current.resolve("A");
document.getElementById('charB').onclick=()=> current && current.resolve("B");
document.getElementById('tie').onclick  =()=> current && current.resolve("TIE");
document.getElementById('undo').onclick =()=>{ if(!historySnaps.length) return; const snap=historySnaps.pop(); restoreSnapshot(snap); document.getElementById('result').innerHTML=""; step(); };
document.getElementById('resetSort').onclick=()=>{ if(poolForSorter.length<2){ showErr('S',"No list loaded."); return; } startInteractiveSort(poolForSorter); };
document.getElementById('shareLinkSort').onclick=async()=>{ try{ const list=editList.filter(x=>x.name&&x.name.trim()).map(x=>({name:x.name.trim(), image:(x.image||'')})); const url=encodeShareLink(list); await navigator.clipboard.writeText(url); alert("Shareable link copied!"); }catch(e){ showErr('S', e.message||e); } };
window.addEventListener('keydown', e=>{ if(document.getElementById('page-sort').style.display==='none') return; const k=e.key.toLowerCase(); if(k==='a') current && current.resolve("A"); if(k==='b') current && current.resolve("B"); if(k==='t') current && current.resolve("TIE"); });
</script>
</body>
</html>
