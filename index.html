<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Character Sorter ‚Äî Create & Sort</title>
<style>
  :root{
    --bg:#f6efe9; --layer:#ffffff; --layer2:#fbf7f3;
    --text:#26272b; --muted:#6e6b66; --border:#e7ddd2;
    --accent:#5865f2; --btn:#efe6dc; --btnH:#e7dccf;
    --danger:#c44949; --ok:#3c7f5e;
    --shadow:0 1px 0 rgba(0,0,0,.03), 0 10px 20px rgba(0,0,0,.04);
    --radius:14px;
  }
  [data-theme="dark"]{
    --bg:#2b2d31; --layer:#313338; --layer2:#2f3136;
    --text:#f2f3f5; --muted:#aeb3bd; --border:#3f4147;
    --accent:#5865f2; --btn:#3b3d45; --btnH:#4a4d56;
    --danger:#d06b6b; --ok:#5bb38c;
    --shadow:0 0 0 rgba(0,0,0,0), 0 12px 24px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:2;background:var(--layer);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
  h1{margin:0;font-size:18px;letter-spacing:.2px}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  .tabs{display:flex;gap:8px;margin:10px 0 16px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:var(--btn);cursor:pointer}
  .tab.active{background:var(--layer);box-shadow:var(--shadow)}
  .card{background:var(--layer);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);margin-bottom:14px}
  .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:15px;background:var(--layer2)}
  .card .body{padding:12px 14px}
  input,textarea,button{font:inherit}
  input,textarea{width:100%;background:var(--layer);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px}
  input:focus,textarea:focus,button:focus{outline:2px solid rgba(88,101,242,.35);outline-offset:2px}
  button{appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--text);padding:10px 14px;border-radius:999px;cursor:pointer}
  button:hover{background:var(--btnH)}
  .btn-ok{border-color:color-mix(in oklab, var(--ok), transparent 40%)}
  .btn-danger{border-color:color-mix(in oklab, var(--danger), transparent 40%)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .rowCard{display:grid;grid-template-columns:56px 1.1fr 1.5fr auto;gap:10px;align-items:center;background:var(--layer);border:1px solid var(--border);border-radius:12px;padding:8px}
  .rowCard img{width:56px;height:56px;object-fit:cover;border-radius:12px;background:var(--layer2);border:1px solid var(--border)}
  .hint{color:var(--muted);font-size:12px}
  .pair{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .char{background:var(--layer);border:1px solid var(--border);border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .06s ease, box-shadow .06s ease,border-color .06s}
  .char:hover{transform:translateY(-1px);box-shadow:var(--shadow);border-color:color-mix(in oklab,var(--accent),transparent 60%)}
  .char img{width:100%;aspect-ratio:1/1;object-fit:cover;background:var(--layer2)}
  .meta{padding:10px;text-align:center;font-weight:700}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  ol{margin:0;padding:0;list-style:none;display:grid;gap:8px}
  .resRow{display:flex;align-items:center;gap:10px;background:var(--layer);border:1px solid var(--border);border-radius:12px;padding:6px}
  .resRow img{width:42px;height:42px;object-fit:cover;border-radius:10px;background:var(--layer2);border:1px solid var(--border)}
  .rank{width:34px;height:34px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:var(--layer2);border:1px solid var(--border);font-weight:700;color:var(--muted)}
  .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0;color:var(--muted);font-size:13px}
  .error{background:color-mix(in oklab,var(--danger),#fff 85%);border:1px solid color-mix(in oklab,var(--danger),#000 80%);color:color-mix(in oklab,var(--danger),#000 40%);padding:8px;border-radius:10px;margin:.5rem 0;display:none}
  .tools{display:flex;gap:8px;flex-wrap:wrap}
  .toggle{padding:8px 12px;border-radius:999px;background:var(--btn);border:1px solid var(--border)}
  @media(max-width:800px){.grid2{grid-template-columns:1fr}.pair{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<header>
  <h1>Character Sorter</h1>
  <button id="themeBtn" class="toggle">üåô Dark</button>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab active" id="tab-create">Create list</button>
    <button class="tab" id="tab-sort">Sort</button>
  </div>

  <!-- CREATE -->
  <section id="page-create">
    <div id="errC" class="error"></div>
    <div class="card">
      <h2>Edit your pool</h2>
      <div class="body">
        <p class="hint">Add characters (name + image URL). If empty, a colored ‚Äú?‚Äù is used.</p>
        <div class="tools">
          <button id="addRow">+ Add character</button>
          <button id="clearList" class="btn-danger">Clear</button>
        </div>
        <div id="rows" style="display:grid;gap:8px;margin-top:10px"></div>
      </div>
    </div>

    <div class="card">
      <h2>Save / Load via Code or Link</h2>
      <div class="body grid2">
        <div>
          <textarea id="exportCode" rows="6" readonly placeholder="Click ‚ÄúGenerate code‚Äù"></textarea>
          <div class="tools">
            <button id="genCode" class="btn-ok">Generate code</button>
            <button id="copyCode">Copy code</button>
            <button id="copyLink">Copy shareable link</button>
          </div>
        </div>
        <div>
          <textarea id="importCode" rows="6" placeholder="Paste code here‚Ä¶"></textarea>
          <div class="tools"><button id="loadCode">Load code</button></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Use this pool</h2>
      <div class="body"><div class="tools"><button id="useInSorter" class="btn-ok">Open in ‚ÄúSort‚Äù tab</button></div></div>
    </div>
  </section>

  <!-- SORT -->
  <section id="page-sort" style="display:none">
    <div id="errS" class="error"></div>
    <div class="card">
      <h2>Duels</h2>
      <div class="body">
        <div class="bar"><span id="status">Ready.</span><span id="progress"></span></div>
        <div id="pair" class="pair" style="display:none">
          <div id="charA" class="char"><img id="imgA"><div class="meta" id="nameA">‚Äî</div></div>
          <div id="charB" class="char"><img id="imgB"><div class="meta" id="nameB">‚Äî</div></div>
        </div>
        <div class="controls">
          <button id="tie">Tie</button>
          <button id="undo">‚Ü©Ô∏é Undo</button>
          <button id="resetSort">Reset</button>
          <button id="shareLinkSort">Copy shareable link</button>
        </div>
        <p class="hint" style="text-align:center">Shortcuts: A / T / B</p>
      </div>
    </div>

    <div class="card">
      <h2>Results</h2>
      <div class="body">
        <div class="tools">
          <button id="exportPNG" class="btn-ok">Export PNG</button>
        </div>
        <ol id="result"></ol>
      </div>
    </div>
  </section>
</div>

<script>
/* ===== Theme ===== */
const THEME_KEY='cs_theme';
function applyTheme(t){document.documentElement.setAttribute('data-theme',t==='dark'?'dark':'light');}
function currentTheme(){return localStorage.getItem(THEME_KEY)||'light';}
function toggleTheme(){const t=currentTheme()==='dark'?'light':'dark';localStorage.setItem(THEME_KEY,t);applyTheme(t);document.getElementById('themeBtn').textContent=t==='dark'?'‚òÄÔ∏è Light':'üåô Dark';}
applyTheme(currentTheme());
document.addEventListener('DOMContentLoaded',()=>{document.getElementById('themeBtn').textContent=currentTheme()==='dark'?'‚òÄÔ∏è Light':'üåô Dark';});
document.getElementById('themeBtn').onclick=toggleTheme;

/* ===== Utils & Storage ===== */
const $=s=>document.querySelector(s);
const rowsEl=$('#rows'); const LS_KEY='cs_pool_v1';
function savePool(list){localStorage.setItem(LS_KEY,JSON.stringify(list));}
function loadPool(){try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]');}catch{return[]}}
function showErr(scope,msg){const el=(scope==='C'?$('#errC'):$('#errS')); el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none';},4000);}

/* ===== Placeholder ‚Äú?‚Äù (data URL) ===== */
const palette=['#ffb6a3','#ffd2a6','#ffe6a8','#c8f0a8','#b7e5ff','#cbb8ff','#ffb8e1','#b8ffe7'];
function hashInt(s){let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}return h>>>0;}
function questionSVG(n){
  const bg=palette[hashInt(n)%palette.length];
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
      <rect width="512" height="512" rx="26" fill="${bg}"/>
      <text x="50%" y="58%" font-size="280" text-anchor="middle" fill="#222" font-family="system-ui" dy=".1em">?</text>
    </svg>`
  );
}
function placeholderFor(n){return questionSVG(n||'Character');}

/* ===== LZ-String (URI variant, MIT) for shorter codes/links ===== */
var LZString=function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={},e={compressToEncodedURIComponent:function(o){return null==o?"":e._compress(o,6,function(o){return n.charAt(o)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:e._decompress(r.length,32,function(t){return o(n,r.charAt(t))})},_compress:function(o,n,t){if(null==o)return"";var e,i,u,s={},p={},a="",c="",l="",h=2,f=3,d=2,m=[],v=0,g=0;for(i=0;i<o.length;i+=1)if(a=o.charAt(i),Object.prototype.hasOwnProperty.call(s,a)||(s[a]=f++,p[a]=!0),c=l+a,Object.prototype.hasOwnProperty.call(s,c))l=c;else{if(Object.prototype.hasOwnProperty.call(p,l)){if(l.charCodeAt(0)<256){for(e=0;e<d;e++)v<<=1,g==n-1?(g=0,m.push(t(v)),v=0):g++;for(u=l.charCodeAt(0),e=0;e<8;e++)v=v<<1|1&u,g==n-1?(g=0,m.push(t(v)),v=0):g++,u>>=1}else{for(u=1,e=0;e<d;e++)v=v<<1|u,g==n-1?(g=0,m.push(t(v)),v=0):g++,u=0;for(u=l.charCodeAt(0),e=0;e<16;e++)v=v<<1|1&u,g==n-1?(g=0,m.push(t(v)),v=0):g++,u>>=1}h--,0==h&&(h=Math.pow(2,d),d++),p[l]=!1}else for(u=s[l],e=0;e<d;e++)v=v<<1|1&u,g==n-1?(g=0,m.push(t(v)),v=0):g++,u>>=1;h--,0==h&&(h=Math.pow(2,d),d++),s[c]=f++,l=String(a);if(0==--h&&(h=Math.pow(2,d),d++))s[l]=f++,p[l]=!0,l="";}if(""!==l){if(Object.prototype.hasOwnProperty.call(p,l)){if(l.charCodeAt(0)<256){for(e=0;e<d;e++)v<<=1,g==n-1?(g=0,m.push(t(v)),v=0):g++;for(u=l.charCodeAt(0),e=0;e<8;e++)v=v<<1|1&u,g==n-1?(g=0,m.push(t(v)),v=0):g++,u>>=1}else{for(u=1,e=0;e<d;e++)v=v<<1|u,g==n-1?(g=0,m.push(t(v)),v=0):g++,u=0;for(u=l.charCodeAt(0),e=0;e<16;e++)v=v<<1|1&u,g==n-1?(g=0,m.push(t(v)),v=0):g++,u>>=1}h--,0==h&&(h=Math.pow(2,d),d++),p[l]=!1}else for(u=s[l],e=0;e<d;e++)v=v<<1|1&u,g==n-1?(g=0,m.push(t(v)),v=0):g++,u>>=1;h--,0==h&&(h=Math.pow(2,d),d++)}for(u=2,e=0;e<d;e++)v=v<<1|1&u,g==n-1?(g=0,m.push(t(v)),v=0):g++,u>>=1;for(;;){if(v<<=1,g==n-1){m.push(t(v));break}g++}return m.join("")},_decompress:function(o,n,t){var e,i,u,s,p,a,c,l,h=[],f=4,d=4,m=3,v="",g=[],y={val:t(0),position:n,index:1};for(i=0;i<3;i+=1)h[i]=i;for(u=0,p=Math.pow(2,2),a=1;a!=p;)s=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=t(y.index++)),u|=(s>0?1:0)*a,a<<=1;switch(e=u){case 0:for(u=0,p=Math.pow(2,8),a=1;a!=p;)s=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=t(y.index++)),u|=(s>0?1:0)*a,a<<=1;h[3]=r(u);break;case 1:for(u=0,p=Math.pow(2,16),a=1;a!=p;)s=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=t(y.index++)),u|=(s>0?1:0)*a,a<<=1;h[3]=r(u);break;case 2:return""}for(c=3,l=e,i=h[3],g.push(i);;){if(y.index>o)return"";for(u=0,p=Math.pow(2,m),a=1;a!=p;)s=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=t(y.index++)),u|=(s>0?1:0)*a,a<<=1;switch(i=u){case 0:for(u=0,p=Math.pow(2,8),a=1;a!=p;)s=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=t(y.index++)),u|=(s>0?1:0)*a,a<<=1;h[d++]=r(u),i=d-1,f--;break;case 1:for(u=0,p=Math.pow(2,16),a=1;a!=p;)s=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=t(y.index++)),u|=(s>0?1:0)*a,a<<=1;h[d++]=r(u),i=d-1,f--;break;case 2:return g.join("")}if(0==f&&(f=Math.pow(2,m),m++),h[i])v=h[i];else{if(i!==d)return null;v=l+v.charAt(0)}g.push(v),h[d++]=l+v.charAt(0),f--,l=v,0==f&&(f=Math.pow(2,m),m++)}}
};return e;}();

/* ===== Codes / Links (short, retro-compatible) ===== */
function encodeCode(list){
  const json=JSON.stringify(list);
  const z=LZString.compressToEncodedURIComponent(json);
  return 'CS2.'+z;
}
function decodeCode(code){
  const t=(code||'').trim();
  if(t.startsWith('CS2.')){
    const json=LZString.decompressFromEncodedURIComponent(t.slice(4));
    if(!json) throw new Error('Corrupted CS2 code.');
    const arr=JSON.parse(json); if(!Array.isArray(arr)) throw new Error('Code does not contain a list.'); return arr;
  }
  if(t.startsWith('CS1.')){
    const p=t.slice(4).replace(/-/g,'+').replace(/_/g,'/'); const pad=p.length%4?'===='.slice(p.length%4):'';
    const json=decodeURIComponent(escape(atob(p+pad))); const arr=JSON.parse(json);
    if(!Array.isArray(arr)) throw new Error('Code does not contain a list.'); return arr;
  }
  throw new Error('Unknown code format.');
}
function encodeShareLink(list){
  const json=JSON.stringify(list);
  const z=LZString.compressToEncodedURIComponent(json);
  return location.origin+location.pathname+'#z='+z;
}
function decodeShareHash(hash){
  if(!hash) return null;
  if(hash.startsWith('#z=')){
    const json=LZString.decompressFromEncodedURIComponent(hash.slice(3));
    if(!json) return null; const arr=JSON.parse(json); return Array.isArray(arr)?arr:null;
  }
  if(hash.startsWith('#data=')){ // legacy
    const p=hash.slice(6).replace(/-/g,'+').replace(/_/g,'/'); const pad=p.length%4?'===='.slice(p.length%4):'';
    const json=decodeURIComponent(escape(atob(p+pad))); const arr=JSON.parse(json); return Array.isArray(arr)?arr:null;
  }
  return null;
}

/* ===== Create UI ===== */
function rowTpl(item, idx){
  const imgSrc=(item.image&&item.image.trim())?item.image:placeholderFor(item.name||'Character');
  const div=document.createElement('div'); div.className='rowCard';
  div.innerHTML=`
    <img src="${imgSrc}">
    <input type="text" placeholder="Name" value="${item.name||''}" data-idx="${idx}" data-k="name">
    <input type="url" placeholder="Image URL (optional)" value="${item.image||''}" data-idx="${idx}" data-k="image">
    <button data-idx="${idx}" class="del">Delete</button>
  `;
  return div;
}
function renderRows(list){rowsEl.innerHTML=''; list.forEach((it,i)=>rowsEl.appendChild(rowTpl(it,i)));}
function currentListFromRows(){
  const nodes=rowsEl.querySelectorAll('input'); const map={};
  nodes.forEach(inp=>{const idx=+inp.dataset.idx,k=inp.dataset.k,v=inp.value.trim(); map[idx]=map[idx]||{name:'',image:''}; map[idx][k]=v;});
  const out=[]; Object.keys(map).sort((a,b)=>+a-+b).forEach(i=>{const it=map[i]; if(it.name) out.push({name:it.name,image:it.image||placeholderFor(it.name)});}); return out;
}
function addRow(name='', image=''){const list=currentListFromRows(); list.push({name, image:image||(name?placeholderFor(name):'')}); renderRows(list); savePool(list);}

/* Create events */
const rowsEl=document.getElementById('rows');
rowsEl.addEventListener('input',e=>{if(e.target.tagName!=='INPUT')return; const list=currentListFromRows(); renderRows(list); savePool(list);});
rowsEl.addEventListener('click',e=>{if(!e.target.classList.contains('del'))return; const idx=+e.target.dataset.idx; const list=currentListFromRows().filter((_,i)=>i!==idx); renderRows(list); savePool(list);});
document.getElementById('addRow').onclick=()=>addRow();
document.getElementById('clearList').onclick=()=>{ if(confirm("Clear the list?")){ renderRows([]); savePool([]);} };
document.getElementById('genCode').onclick=()=>{try{const list=currentListFromRows(); if(list.length<2) throw new Error("Add at least 2 characters."); document.getElementById('exportCode').value=encodeCode(list);}catch(e){showErr('C',e.message||e);}};
document.getElementById('copyCode').onclick=async()=>{try{const v=document.getElementById('exportCode').value.trim(); if(!v) throw new Error("Generate a code first."); await navigator.clipboard.writeText(v); alert("Code copied!");}catch(e){showErr('C',e.message||e);}};
document.getElementById('copyLink').onclick=async()=>{try{const list=currentListFromRows(); if(list.length<2) throw new Error("Add at least 2 characters."); const url=encodeShareLink(list); await navigator.clipboard.writeText(url); alert("Shareable link copied!");}catch(e){showErr('C',e.message||e);}};
document.getElementById('loadCode').onclick=()=>{try{const code=document.getElementById('importCode').value.trim(); if(!code) throw new Error("Paste a code first."); const list=decodeCode(code); renderRows(list); savePool(list); alert("List imported!");}catch(e){showErr('C',e.message||e);} };
document.getElementById('useInSorter').onclick=()=>{try{const list=currentListFromRows(); if(list.length<2) throw new Error("Add at least 2 characters."); poolForSorter=JSON.parse(JSON.stringify(list)); switchTab('sort'); startInteractiveSort(poolForSorter);}catch(e){showErr('C',e.message||e);} };

/* Defaults: Scooby names + ‚Äú?‚Äù images */
(function initCreate(){
  const fromHash=decodeShareHash(location.hash);
  if(fromHash&&fromHash.length){renderRows(fromHash); savePool(fromHash); return;}
  const stored=loadPool();
  if(stored.length){renderRows(stored);}
  else{
    const scooby=[
      {name:"Scooby-Doo",    image:placeholderFor("Scooby-Doo")},
      {name:"Shaggy Rogers", image:placeholderFor("Shaggy Rogers")},
      {name:"Velma Dinkley", image:placeholderFor("Velma Dinkley")},
      {name:"Daphne Blake",  image:placeholderFor("Daphne Blake")},
      {name:"Fred Jones",    image:placeholderFor("Fred Jones")}
    ];
    renderRows(scooby); savePool(scooby);
  }
})();

/* Tabs */
function switchTab(which){
  const isCreate=which==='create';
  document.getElementById('tab-create').classList.toggle('active',isCreate);
  document.getElementById('tab-sort').classList.toggle('active',!isCreate);
  document.getElementById('page-create').style.display=isCreate?'block':'none';
  document.getElementById('page-sort').style.display=isCreate?'none':'block';
}
document.getElementById('tab-create').onclick=()=>switchTab('create');
document.getElementById('tab-sort').onclick=()=>switchTab('sort');

/* ===== Sort engine (interactive merge sort + undo) ===== */
let poolForSorter=[], pending=[], nextRuns=[], current=null, result=null;
let comparisonsDone=0, comparisonsTotal=0;
let historySnaps=[]; let latestResult=[];

function snapshot(){return JSON.stringify({pending,nextRuns,comparisonsDone});}
function restoreSnapshot(s){const o=JSON.parse(s); pending=o.pending; nextRuns=o.nextRuns; comparisonsDone=o.comparisonsDone; result=null; current=null;}
function estimate(n){return Math.max(0,Math.floor(n*Math.log2(Math.max(1,n))));}
function makeMerges(runs){const merges=[]; for(let i=0;i<runs.length;i+=2){const L=runs[i].slice(); const R=i+1<runs.length?runs[i+1].slice():[]; merges.push({left:L,right:R,out:[]});} return merges;}
function setStatus(t){document.getElementById('status').textContent=t;}
function setProgress(done,total){document.getElementById('progress').textContent=total?`Comparisons: ${done}/${total}`:"";}
function showPair(a,b){
  document.getElementById('pair').style.display='grid';
  document.getElementById('nameA').textContent=a.name; document.getElementById('imgA').src=a.image||placeholderFor(a.name);
  document.getElementById('nameB').textContent=b.name; document.getElementById('imgB').src=b.image||placeholderFor(b.name);
}
function startInteractiveSort(items){
  pending=makeMerges(items.map(x=>[x])); nextRuns=[]; current=null; result=null; historySnaps=[]; latestResult=[];
  comparisonsDone=0; comparisonsTotal=estimate(items.length); setProgress(comparisonsDone,comparisonsTotal);
  document.getElementById('result').innerHTML="";
  if(pending.length===1 && pending[0].right.length===0){ result=pending[0].left; document.getElementById('pair').style.display='none'; return renderResult(result); }
  step();
}
function step(){
  if(current) return;
  if(pending.length===0){
    if(nextRuns.length===1){ result=nextRuns[0]; document.getElementById('pair').style.display='none'; return renderResult(result); }
    pending=makeMerges(nextRuns); nextRuns=[];
  }
  const m=pending[0]; if(!m) return;
  if(m.left.length===0 && m.right.length===0){ nextRuns.push(m.out); pending.shift(); return step(); }
  if(m.left.length===0){ m.out.push(m.right.shift()); return step(); }
  if(m.right.length===0){ m.out.push(m.left.shift()); return step(); }
  const A=m.left[0], B=m.right[0];
  showPair(A,B); setStatus("Choose: click A / Tie / click B");
  current={resolve:(choice)=>{
    historySnaps.push(snapshot());
    if(choice==="A") m.out.push(m.left.shift());
    else if(choice==="B") m.out.push(m.right.shift());
    else { const x=m.left.shift(), y=m.right.shift(); m.out.push(x,y); }
    comparisonsDone++; setProgress(comparisonsDone,comparisonsTotal);
    current=null; setTimeout(step,0);
  }};
}
function renderResult(arr){
  setStatus("Sorting finished üéâ"); latestResult = arr.slice();
  const ol=document.getElementById('result'); ol.innerHTML="";
  arr.forEach((x,i)=>{
    const li=document.createElement('li'); li.className='resRow';
    const src=x.image||placeholderFor(x.name);
    li.innerHTML=`<div class="rank">${i+1}</div><img src="${src}" alt=""><div class="nm">${x.name}</div>`;
    ol.appendChild(li);
  });
}

/* Actions */
document.getElementById('charA').onclick=()=> current && current.resolve("A");
document.getElementById('charB').onclick=()=> current && current.resolve("B");
document.getElementById('tie').onclick =()=> current && current.resolve("TIE");
document.getElementById('undo').onclick=()=>{
  if(!historySnaps.length) return; const snap=historySnaps.pop(); restoreSnapshot(snap); document.getElementById('result').innerHTML=""; step();
};
document.getElementById('resetSort').onclick=()=>{ if(poolForSorter.length<2){showErr('S',"No list loaded."); return;} startInteractiveSort(poolForSorter); };
document.getElementById('shareLinkSort').onclick=async()=>{ try{ const list=poolForSorter&&poolForSorter.length?poolForSorter:loadPool(); const url=encodeShareLink(list); await navigator.clipboard.writeText(url); alert("Shareable link copied!"); }catch(e){ showErr('S', e.message||e); } };
window.addEventListener('keydown',e=>{const k=e.key.toLowerCase(); if(k==='a') current && current.resolve("A"); if(k==='b') current && current.resolve("B"); if(k==='t') current && current.resolve("TIE");});

/* Preload for Sort */
(function initSort(){
  const fromHash=decodeShareHash(location.hash);
  if(fromHash&&fromHash.length){ poolForSorter=JSON.parse(JSON.stringify(fromHash)); savePool(fromHash); }
  else{ const p=loadPool(); if(p&&p.length>=2) poolForSorter=JSON.parse(JSON.stringify(p)); }
})();

/* ===== Export PNG of results (offline) ===== */
async function exportResultsPNG(){
  try{
    const data = latestResult && latestResult.length ? latestResult : null;
    if(!data){ alert("No results yet. Finish a sort first."); return; }

    // layout
    const W = Math.min(1000, Math.max(600, Math.floor(window.innerWidth*0.9)));
    const PAD = 24, GAP = 10, TH = 64, RANKW = 42, TEXTX = PAD + RANKW + 10 + TH + 10;
    const ROWH = Math.max(TH, 42) + 16;
    const H = PAD*2 + data.length*ROWH + 30; // +title
    const cvs = document.createElement('canvas'); cvs.width=W; cvs.height=H;
    const ctx = cvs.getContext('2d');

    // theme-aware colors
    const dark = document.documentElement.getAttribute('data-theme')==='dark';
    const bg = dark ? '#2b2d31' : '#f6efe9';
    const card = dark ? '#313338' : '#ffffff';
    const border = dark ? '#3f4147' : '#e7ddd2';
    const text = dark ? '#f2f3f5' : '#26272b';
    const muted = dark ? '#aeb3bd' : '#6e6b66';

    // bg
    ctx.fillStyle = bg; ctx.fillRect(0,0,W,H);

    // title card
    ctx.fillStyle = card; roundRect(ctx, PAD, PAD, W-PAD*2, 40, 12); ctx.fill();
    ctx.strokeStyle = border; ctx.lineWidth = 1; roundRect(ctx, PAD, PAD, W-PAD*2, 40, 12); ctx.stroke();
    ctx.fillStyle = text; ctx.font = '700 18px system-ui,Segoe UI,Roboto,Arial';
    ctx.fillText('Character Sorter ‚Äî Results', PAD+14, PAD+26);

    // list card
    const listY = PAD+40+GAP;
    ctx.fillStyle = card; roundRect(ctx, PAD, listY, W-PAD*2, H-listY-PAD, 12); ctx.fill();
    ctx.strokeStyle = border; roundRect(ctx, PAD, listY, W-PAD*2, H-listY-PAD, 12); ctx.stroke();

    // helpers
    function drawRank(i, x, y){
      ctx.fillStyle = dark ? '#2f3136' : '#fbf7f3';
      roundRect(ctx, x, y, RANKW, TH, 10); ctx.fill(); ctx.strokeStyle=border; ctx.stroke();
      ctx.fillStyle = muted; ctx.font='700 18px system-ui,Segoe UI,Roboto,Arial';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(String(i+1), x+RANKW/2, y+TH/2);
      ctx.textAlign='start'; ctx.textBaseline='alphabetic';
    }
    async function loadImageSafe(src, name){
      return new Promise(resolve=>{
        const img = new Image();
        // try CORS for remote images; data: and same-origin will be fine anyway
        img.crossOrigin = 'anonymous';
        img.onload = ()=>resolve(img);
        img.onerror = ()=>{
          const ph = new Image(); ph.onload=()=>resolve(ph); ph.src = placeholderFor(name||'Character');
        };
        img.src = (src && src.trim()) ? src : placeholderFor(name||'Character');
      });
    }

    // draw rows
    let y = listY + PAD;
    for(let i=0;i<data.length;i++){
      const it = data[i];
      // rank
      drawRank(i, PAD+14, y+(TH-TH)/2);
      // thumb frame
      const thumbX = PAD+14+RANKW+10;
      ctx.fillStyle = dark ? '#2f3136' : '#fbf7f3';
      roundRect(ctx, thumbX, y, TH, TH, 10); ctx.fill(); ctx.strokeStyle=border; ctx.stroke();

      // image
      const img = await loadImageSafe(it.image, it.name);
      try{
        ctx.save();
        clipRoundRect(ctx, thumbX, y, TH, TH, 10);
        ctx.drawImage(img, thumbX, y, TH, TH);
        ctx.restore();
      }catch{ /* if tainted, we already replaced with placeholder */ }

      // name
      ctx.fillStyle = text;
      ctx.font = '700 18px system-ui,Segoe UI,Roboto,Arial';
      ctx.fillText(it.name, TEXTX, y+28);
      // small muted line
      ctx.fillStyle = muted; ctx.font = '12px system-ui,Segoe UI,Roboto,Arial';
      ctx.fillText('', TEXTX, y+48);

      y += ROWH;
    }

    // download
    cvs.toBlob(blob=>{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='character-sorter-results.png';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();}, 500);
    }, 'image/png');

  }catch(err){
    showErr('S', 'Export failed: ' + (err && err.message ? err.message : err));
  }
}
// rounded rect helpers
function roundRect(ctx,x,y,w,h,r){const rr=Math.min(r, w/2, h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath();}
function clipRoundRect(ctx,x,y,w,h,r){roundRect(ctx,x,y,w,h,r); ctx.clip();}

document.getElementById('exportPNG').onclick = exportResultsPNG;
</script>
</body>
</html>
