<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Character Sorter — Create & Sort</title>
<style>
  :root{
    /* Discord-ish with soft peach vibe */
    --bg:#f6efe9;         /* soft peach canvas */
    --layer:#ffffff;      /* card surface */
    --layer2:#fbf7f3;     /* subtle panel */
    --text:#26272b;       /* primary text */
    --muted:#6e6b66;      /* secondary text */
    --border:#e7ddd2;     /* soft border */
    --accent:#5865f2;     /* discord blurple (light use) */
    --btn:#efe6dc;        /* pill buttons */
    --btnH:#e7dccf;
    --danger:#c44949;
    --ok:#3c7f5e;
    --shadow:0 1px 0 rgba(0,0,0,.03), 0 10px 20px rgba(0,0,0,.04);
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:2;background:linear-gradient(#fffaf6, #fbf6f1);border-bottom:1px solid var(--border);padding:14px 16px;display:flex;gap:10px;align-items:center}
  h1{margin:0;font-size:18px;letter-spacing:.2px}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  .tabs{display:flex;gap:8px;margin:10px 0 16px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:var(--btn);cursor:pointer}
  .tab.active{background:#fff;border-color:#dacdbf;box-shadow:var(--shadow)}
  .card{background:var(--layer);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);margin-bottom:14px}
  .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:15px;background:var(--layer2)}
  .card .body{padding:12px 14px}
  input,textarea,button{font:inherit}
  input,textarea{width:100%;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
  input:focus,textarea:focus,button:focus{outline:2px solid rgba(88,101,242,.35);outline-offset:2px}
  button{appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--text);padding:11px 14px;border-radius:999px;cursor:pointer}
  button:hover{background:var(--btnH)}
  .btn-ok{border-color:#9cc7b1}
  .btn-danger{border-color:#e3b4b4}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .rowCard{display:grid;grid-template-columns:56px 1.1fr 1.5fr auto;gap:10px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px}
  .rowCard img{width:56px;height:56px;object-fit:cover;border-radius:12px;background:#f2ebe5;border:1px solid var(--border)}
  .rowCard button{padding:8px 10px}
  .hint{color:var(--muted);font-size:12px}
  .pair{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .char{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .06s ease, box-shadow .06s ease}
  .char:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
  .char img{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f2ebe5}
  .meta{padding:10px;text-align:center;font-weight:700}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  ol{margin:0;padding-left:0;list-style:none;display:grid;gap:8px}
  .resRow{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:6px}
  .resRow img{width:42px;height:42px;object-fit:cover;border-radius:10px;background:#f2ebe5;border:1px solid var(--border)}
  .rank{width:34px;height:34px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#fff5ef;border:1px solid var(--border);font-weight:700;color:#7a6b57}
  .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0;color:var(--muted);font-size:13px}
  .error{background:#faece9;border:1px solid #e3c1ba;color:#7e3429;padding:8px;border-radius:10px;margin:.5rem 0;display:none}
  .tools{display:flex;gap:8px;flex-wrap:wrap}
  .pill{font-size:12px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:#fff5ef;color:#8b7a6a}
  @media (max-width:800px){
    .grid2{grid-template-columns:1fr}
    .pair{grid-template-columns:1fr 1fr}
    .rowCard{grid-template-columns:56px 1fr 1fr auto}
  }
</style>
</head>
<body>
<header>
  <h1>⚡ Character Sorter — Create & Sort</h1>
  <span class="pill">Discord-like • soft peach</span>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab active" id="tab-create">Create list</button>
    <button class="tab" id="tab-sort">Sort</button>
  </div>

  <!-- ==== CREATE PAGE ==== -->
  <section id="page-create">
    <div id="errC" class="error"></div>

    <div class="card">
      <h2>Edit your pool</h2>
      <div class="body">
        <p class="hint">Add characters (name + image URL). If image is empty, a clean **Discord-style avatar** is generated from the name (initials, pastel background).</p>
        <div class="tools">
          <button id="addRow">+ Add character</button>
          <button id="clearList" class="btn-danger">Clear</button>
        </div>
        <div id="rows" style="display:grid;gap:8px;margin-top:10px"></div>
      </div>
    </div>

    <div class="card">
      <h2>Save / Load via Code or Link</h2>
      <div class="body grid2">
        <div>
          <div class="hint">Generate a reusable <b>code</b>. Or copy a <b>shareable link</b> (URL with your pool in <code>#data=</code>).</div>
          <textarea id="exportCode" rows="6" readonly placeholder="Click “Generate code”"></textarea>
          <div class="tools">
            <button id="genCode" class="btn-ok">Generate code</button>
            <button id="copyCode">Copy code</button>
            <button id="copyLink">Copy shareable link</button>
          </div>
        </div>
        <div>
          <div class="hint">Paste a previously saved <b>code</b> below to restore your pool.</div>
          <textarea id="importCode" rows="6" placeholder="Paste code here…"></textarea>
          <div class="tools">
            <button id="loadCode">Load code</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Use this pool</h2>
      <div class="body">
        <div class="tools">
          <button id="useInSorter" class="btn-ok">Open in “Sort” tab</button>
        </div>
        <p class="hint">Your pool is also saved locally (browser) and restored automatically.</p>
      </div>
    </div>
  </section>

  <!-- ==== SORT PAGE ==== -->
  <section id="page-sort" style="display:none">
    <div id="errS" class="error"></div>

    <div class="card">
      <h2>Duels</h2>
      <div class="body">
        <div class="bar"><span id="status">Ready.</span><span id="progress"></span></div>
        <div id="pair" class="pair" style="display:none">
          <div id="charA" class="char" role="button" aria-label="Pick A">
            <img id="imgA" alt=""><div class="meta" id="nameA">—</div>
          </div>
          <div id="charB" class="char" role="button" aria-label="Pick B">
            <img id="imgB" alt=""><div class="meta" id="nameB">—</div>
          </div>
        </div>
        <div class="controls">
          <button id="tie">Tie</button>
          <button id="undo">↩︎ Undo</button>
          <button id="resetSort">Reset</button>
          <button id="shareLinkSort">Copy shareable link</button>
        </div>
        <p class="hint" style="text-align:center">Shortcuts: A / T / B</p>
      </div>
    </div>

    <div class="card">
      <h2>Results</h2>
      <div class="body">
        <ol id="result"></ol>
      </div>
    </div>
  </section>
</div>

<script>
/* ========= Utilities & Storage ========= */
const $=s=>document.querySelector(s);
const rowsEl = $('#rows');
const LS_KEY = 'cs_pool_v1';
function savePool(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }
function loadPool(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{return []} }

/* Discord-style avatar generator (SVG data URL) */
const pastel = ['#ffd9c8','#ffe4d6','#ffe9df','#ffdccc','#ffe8d5','#ffeddc','#ffe2d2','#ffe9d8'];
function hashInt(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); } return h>>>0; }
function initialsOf(name){
  const parts = name.split(/\s+/).filter(Boolean);
  const letters = parts.slice(0,2).map(p=>p[0]).join('').toUpperCase();
  return letters || '??';
}
function avatarSVG(name){
  const seed = name || 'Character';
  const bg = pastel[hashInt(seed)%pastel.length];
  const txt = '#2b2b2b';
  const init = initialsOf(seed);
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'>
    <defs><filter id='s' x='-50%' y='-50%' width='200%' height='200%'><feDropShadow dx='0' dy='2' stdDeviation='6' flood-color='rgba(0,0,0,.12)'/></filter></defs>
    <rect width='512' height='512' rx='24' ry='24' fill='${bg}'/>
    <circle cx='256' cy='240' r='160' fill='white' filter='url(#s)' />
    <text x='256' y='252' text-anchor='middle' font-family='system-ui,Segoe UI,Roboto,Arial' font-size='160' font-weight='700' fill='${txt}'>${init}</text>
    <rect x='116' y='340' width='280' height='100' rx='18' fill='white' opacity='0.9'/>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}
function avatarFor(name){ return avatarSVG(name||'Character'); }

/* Code format: base64 URL-safe with prefix */
function encodeCode(list){
  const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(list))));
  return 'CS1.'+b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function decodeCode(code){
  const t = code.trim();
  if(!/^CS1\.[A-Za-z0-9\-_]+$/.test(t)) throw new Error("Invalid or corrupted code.");
  const p = t.slice(4).replace(/-/g,'+').replace(/_/g,'/');
  const pad = p.length%4 ? '===='.slice(p.length%4) : '';
  const json = decodeURIComponent(escape(atob(p+pad)));
  const arr = JSON.parse(json);
  if(!Array.isArray(arr)) throw new Error("Code does not contain a list.");
  return arr;
}
/* Share link in URL hash (#data=...) */
function encodeShareLink(list){
  const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(list))))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  return location.origin + location.pathname + '#data=' + b64;
}
function decodeShareHash(hash){
  if(!hash || !hash.startsWith('#data=')) return null;
  const p = hash.slice(6).replace(/-/g,'+').replace(/_/g,'/');
  const pad = p.length%4 ? '===='.slice(p.length%4) : '';
  const json = decodeURIComponent(escape(atob(p+pad)));
  const arr = JSON.parse(json);
  return Array.isArray(arr) ? arr : null;
}

/* ========= CREATE UI ========= */
function rowTpl(item, idx){
  const imgSrc = (item.image && item.image.trim()) ? item.image : avatarFor(item.name||'Character');
  const div = document.createElement('div'); div.className='rowCard';
  div.innerHTML = `
    <img src="${imgSrc}">
    <input type="text" placeholder="Name" value="${item.name||''}" data-idx="${idx}" data-k="name">
    <input type="url" placeholder="Image URL (optional)" value="${item.image||''}" data-idx="${idx}" data-k="image">
    <button data-idx="${idx}" class="del">Delete</button>
  `;
  return div;
}
function renderRows(list){
  rowsEl.innerHTML='';
  list.forEach((it,i)=> rowsEl.appendChild(rowTpl(it,i)));
}
function currentListFromRows(){
  const nodes = rowsEl.querySelectorAll('input');
  const map = {};
  nodes.forEach(inp=>{
    const idx = +inp.dataset.idx, k = inp.dataset.k, v = inp.value.trim();
    map[idx] = map[idx] || {name:'',image:''};
    map[idx][k] = v;
  });
  const out = [];
  Object.keys(map).sort((a,b)=>+a-+b).forEach(i=>{
    const it = map[i];
    if(it.name) out.push({name:it.name, image: it.image || avatarFor(it.name)});
  });
  return out;
}
function addRow(name='', image=''){
  const list = currentListFromRows();
  list.push({name, image: image || (name?avatarFor(name):'')});
  renderRows(list); savePool(list);
}

/* Create page events */
rowsEl.addEventListener('input', e=>{
  if(e.target.tagName!=='INPUT') return;
  const list = currentListFromRows();
  renderRows(list); savePool(list);
});
rowsEl.addEventListener('click', e=>{
  if(!e.target.classList.contains('del')) return;
  const idx = +e.target.dataset.idx;
  const list = currentListFromRows().filter((_,i)=>i!==idx);
  renderRows(list); savePool(list);
});
$('#addRow').onclick = ()=> addRow();
$('#clearList').onclick = ()=> { if(confirm("Clear the list?")){ renderRows([]); savePool([]); } };
$('#genCode').onclick = ()=>{
  try{
    const list = currentListFromRows();
    if(list.length<2) throw new Error("Add at least 2 characters.");
    $('#exportCode').value = encodeCode(list);
  }catch(e){ showErr('C', e.message||e); }
};
$('#copyCode').onclick = async ()=>{
  try{
    const v = $('#exportCode').value.trim(); if(!v) throw new Error("Generate a code first.");
    await navigator.clipboard.writeText(v); alert("Code copied!");
  }catch(e){ showErr('C', e.message||e); }
};
$('#copyLink').onclick = async ()=>{
  try{
    const list = currentListFromRows();
    if(list.length<2) throw new Error("Add at least 2 characters.");
    const url = encodeShareLink(list);
    await navigator.clipboard.writeText(url);
    alert("Shareable link copied!");
  }catch(e){ showErr('C', e.message||e); }
};
$('#loadCode').onclick = ()=>{
  try{
    const code = $('#importCode').value.trim(); if(!code) throw new Error("Paste a code first.");
    const list = decodeCode(code);
    renderRows(list); savePool(list);
    alert("List imported!");
  }catch(e){ showErr('C', e.message||e); }
};
$('#useInSorter').onclick = ()=>{
  try{
    const list = currentListFromRows();
    if(list.length<2) throw new Error("Add at least 2 characters.");
    poolForSorter = JSON.parse(JSON.stringify(list));
    switchTab('sort'); startInteractiveSort(poolForSorter);
  }catch(e){ showErr('C', e.message||e); }
};
/* Load on startup for Create tab — prefer #data= if present */
(function initCreate(){
  const fromHash = decodeShareHash(location.hash);
  if(fromHash && fromHash.length){ renderRows(fromHash); savePool(fromHash); return; }
  const stored = loadPool();
  if(stored.length){ renderRows(stored); }
  else{
    /* Default placeholders = Scooby gang names, avatar SVGs (license-safe) */
    const scooby = [
      {name:"Scooby-Doo",    image:avatarFor("Scooby-Doo")},
      {name:"Shaggy Rogers", image:avatarFor("Shaggy Rogers")},
      {name:"Velma Dinkley", image:avatarFor("Velma Dinkley")},
      {name:"Daphne Blake",  image:avatarFor("Daphne Blake")},
      {name:"Fred Jones",    image:avatarFor("Fred Jones")}
    ];
    renderRows(scooby); savePool(scooby);
  }
})();

/* ========= Tabs ========= */
function switchTab(which){
  const isCreate = which==='create';
  $('#tab-create').classList.toggle('active', isCreate);
  $('#tab-sort').classList.toggle('active', !isCreate);
  $('#page-create').style.display = isCreate? 'block':'none';
  $('#page-sort').style.display   = isCreate? 'none':'block';
}
$('#tab-create').onclick = ()=> switchTab('create');
$('#tab-sort').onclick   = ()=> switchTab('sort');

/* ========= Error helpers ========= */
function showErr(scope, msg){
  const el = (scope==='C'?$('#errC'):$('#errS'));
  el.textContent = msg; el.style.display='block';
  setTimeout(()=>{ el.style.display='none'; }, 4000);
}

/* ========= Sort engine (interactive merge sort + robust undo) ========= */
let poolForSorter = [];
let pending=[], nextRuns=[], current=null, result=null;
let comparisonsDone=0, comparisonsTotal=0;
let historySnaps=[]; // snapshot BEFORE each user click

function snapshot(){
  return JSON.stringify({ pending, nextRuns, comparisonsDone });
}
function restoreSnapshot(s){
  const o = JSON.parse(s);
  pending = o.pending; nextRuns = o.nextRuns; comparisonsDone = o.comparisonsDone;
  result=null; current=null;
}
function estimate(n){ return Math.max(0, Math.floor(n * Math.log2(Math.max(1,n)))); }
function makeMerges(runs){
  const merges=[]; for(let i=0;i<runs.length;i+=2){
    const L=runs[i].slice(); const R=i+1<runs.length?runs[i+1].slice():[];
    merges.push({left:L,right:R,out:[]});
  } return merges;
}
function setStatus(t){ $('#status').textContent=t; }
function setProgress(done,total){ $('#progress').textContent = total? `Comparisons: ${done}/${total}` : ""; }
function showPair(a,b){
  $('#pair').style.display='grid';
  $('#nameA').textContent=a.name; $('#imgA').src=a.image||avatarFor(a.name);
  $('#nameB').textContent=b.name; $('#imgB').src=b.image||avatarFor(b.name);
}

function startInteractiveSort(items){
  pending = makeMerges(items.map(x=>[x]));
  nextRuns = []; current=null; result=null; historySnaps=[];
  comparisonsDone=0; comparisonsTotal=estimate(items.length);
  setProgress(comparisonsDone, comparisonsTotal);
  $('#result').innerHTML="";
  if(pending.length===1 && pending[0].right.length===0){
    result=pending[0].left; $('#pair').style.display='none'; return renderResult(result);
  }
  step();
}

function step(){
  if(current) return;
  if(pending.length===0){
    if(nextRuns.length===1){ result=nextRuns[0]; $('#pair').style.display='none'; return renderResult(result); }
    pending = makeMerges(nextRuns); nextRuns=[];
  }
  const m=pending[0]; if(!m) return;
  if(m.left.length===0 && m.right.length===0){ nextRuns.push(m.out); pending.shift(); return step(); }
  if(m.left.length===0){ m.out.push(m.right.shift()); return step(); }
  if(m.right.length===0){ m.out.push(m.left.shift()); return step(); }

  const A=m.left[0], B=m.right[0];
  showPair(A,B); setStatus("Choose: click A / Tie / click B");
  current = {
    resolve:(choice)=>{
      historySnaps.push(snapshot());               // robust UNDO
      if(choice==="A"){ m.out.push(m.left.shift()); }
      else if(choice==="B"){ m.out.push(m.right.shift()); }
      else { const x=m.left.shift(), y=m.right.shift(); m.out.push(x,y); }
      comparisonsDone++; setProgress(comparisonsDone,comparisonsTotal);
      current=null; setTimeout(step,0);
    }
  };
}

function renderResult(arr){
  setStatus("Sorting finished 🎉");
  const ol=$('#result'); ol.innerHTML="";
  arr.forEach((x,i)=>{
    const li=document.createElement('li'); li.className='resRow';
    const src = x.image || avatarFor(x.name);
    li.innerHTML=`<div class="rank">${i+1}</div><img src="${src}" alt=""><div class="nm">${x.name}</div>`;
    ol.appendChild(li);
  });
}

/* Sort actions */
$('#charA').onclick = ()=> current && current.resolve("A");
$('#charB').onclick = ()=> current && current.resolve("B");
$('#tie').onclick   = ()=> current && current.resolve("TIE");
$('#undo').onclick  = ()=>{
  if(!historySnaps.length) return;
  const snap = historySnaps.pop();
  restoreSnapshot(snap);
  $('#result').innerHTML="";
  step(); // re-show the same pair
};
$('#resetSort').onclick = ()=>{
  if(poolForSorter.length<2){ showErr('S',"No list loaded."); return; }
  startInteractiveSort(poolForSorter);
};
$('#shareLinkSort').onclick = async ()=>{
  try{
    const list = poolForSorter && poolForSorter.length ? poolForSorter : loadPool();
    const url = encodeShareLink(list);
    await navigator.clipboard.writeText(url);
    alert("Shareable link copied!");
  }catch(e){ showErr('S', e.message||e); }
};
window.addEventListener('keydown', (e)=>{
  const k=e.key.toLowerCase();
  if(k==='a') current && current.resolve("A");
  if(k==='b') current && current.resolve("B");
  if(k==='t') current && current.resolve("TIE"); // T = Tie
});

/* If user opens Sort first, preload from localStorage or #data= */
(function initSort(){
  const fromHash = decodeShareHash(location.hash);
  if(fromHash && fromHash.length){ poolForSorter = JSON.parse(JSON.stringify(fromHash)); savePool(fromHash); }
  else{
    const p = loadPool();
    if(p && p.length>=2){ poolForSorter = JSON.parse(JSON.stringify(p)); }
  }
})();
</script>
</body>
</html>
